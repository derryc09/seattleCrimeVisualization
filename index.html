<html class="gr__duspviz_mit_edu"><head>
    <title>Seattle Crime Visualization</title>
    <link rel="stylesheet" href="multirange.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="multirange.js"></script>
    <script src="gn-seattle.geojson"></script>
    <script src="seattleCrimeData.geojson"></script>    
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> 
    <script src="https://d3js.org/topojson.v1.min.js"></script>

</head>

<!--Silder for the filter-->
<div id="sliderContainer">  
    <div class="filterByYear">
        Filter by year<br>
        <input onchange="update()"id="yearSlide" type="range" multiple value="0,6" min="0" max="6" step="1"/>
        <p>From <span id="startYear">2017</span> to <span id="endYear">2011</span></p>
        <!--<span id="range">2017</span><br>-->
    </div>
    <br>
    <div class="filterByMonth">
        Filter by month<br>
        <input onchange="updateMonth()" id="monthSlide" type="range" multiple value="1,12" min="1" max="12" step="1" />
        <p>From <span id="startMonth">Janurary</span> to <span id="endMonth">December</span></p>
    </div>
    <br><br>
    <button id="start">Start</button>
    <button id="startWithAnimation">Start with Animation</button>
    <button id="stop">Reload and Refresh</button>    
    <!--<button id="reset">Reset</button>-->
</div>



<body data-gr-c-s-loaded="true">
   <h1>Crime Incidents in Seattle</h1>
   <h2>Hover over plot points for incident description.</h2>
   <div class="container-unique"></div>


   <div class="container2">
        <h1>Count of burglaries by month</h1>
   </div>
</body>
<style>

    body {
        font-family: "Proxima Nova", "Montserrat", sans-serif;
        padding-left:50px;
    }
    
    h1, h2 {
        left: 10px;
        font-size: 1.3em;
        font-weight: 100;
    }
    h2 {
        top: 30px;
        font-size: 1em;
    }
    svg{
        text-align: l;
        margin: 0 auto;
    }
    .thumb{
        display: none;
    }
    /*.hover {
        fill: yellow;   
        r:15;
    }    */
    .container{
        margin-top:40px;
    }
    .container2>h3{
        margin-bottom: 0px;
        margin-top:50px;
    }
    /*circle:hover{
        cursor: pointer;
        fill:red;
        r:10;
    }*/
    #sliderContainer{
        top: 300px;
        left: 50%;
        width: 220px;
        min-width: 220px;
        text-align: center;
        position: absolute;
    }
    .axis {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }    
</style>
 <script>
    var width = 700;
    var height = 580;
    var centered;
    var counter = 0;
    var inputValue = null;
    var countsByMonth = [0,0,0,0,0,0,0,0,0,0,0,0];
    var year = [2017,2016,2015,2014,2013,2012,2011]; //Slider selections
    var month = ["Janurary", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];


    var svg = d3.select( ".container-unique" ) //creates SVG
        .append( "svg" )
        .attr( "width", width )
        .attr( "height", height );

    var g = svg.append( "g" );
    var albersProjection = d3.geo.albers()  //create albers projection
        .scale( 190000 )  
        .rotate( [122.3221,0] )   //rotate the projection to 
        .center( [0, 47.6062] )   //point to Seattle
        .translate( [width/2,height/2] );
       

    var geoPath = d3.geo.path()
        .projection(albersProjection );  //store this path as a variable.

    var filtered2017 = [];
    var filtered2016 = [];
    var filtered2015 = [];
    var filtered2014 = [];
    var filtered2013 = [];
    var filtered2012 = [];
    var filtered2011 = [];
    for(var i = 0; i < crimedata.features.length; i++){
        if(
        crimedata.features[i].geometry.coordinates[1] < 47.693313599 && 
        crimedata.features[i].geometry.coordinates[1] > 47.51726532 && 
        crimedata.features[i].geometry.coordinates[0] < -122.245992 && 
        crimedata.features[i].geometry.coordinates[0] > -122.435417)
        {
            var calculatedYear = new Date(crimedata.features[i].properties["Date Reported"]).getYear() + 1900;
            countsByMonth[new Date(crimedata.features[i].properties["Date Reported"]).getMonth()]++;

            if(calculatedYear == "2011"){
                filtered2011.push(crimedata.features[i]);
            } else if(calculatedYear == "2012"){
                filtered2012.push(crimedata.features[i]);
            } else if(calculatedYear == "2013"){
                filtered2013.push(crimedata.features[i]);
            } else if(calculatedYear == "2014"){
                filtered2014.push(crimedata.features[i]);
            } else if(calculatedYear == "2015"){
                filtered2015.push(crimedata.features[i]);
            } else if(calculatedYear == "2016"){
                filtered2016.push(crimedata.features[i]);
            } else if(calculatedYear == "2017"){
                filtered2017.push(crimedata.features[i]);
            }        
        }
    }

    var allData = [filtered2017,filtered2016,filtered2015,filtered2014,filtered2013,filtered2012, filtered2011]
    g.selectAll( "path" )                   
        .data(neighborhoods_json.features)  //grabs seattle neighborhood svg data. 
        .enter()
        .append( "path" )
        .attr( "fill", "none" )
        .attr( "stroke", "grey")
        .attr( "d", geoPath );
    
    
    d3.select("#monthSlide").on("input", function() {  //updates the value per each slide. 
        updateMonth(this.value);
    });
    function updateMonth(){
        document.getElementById("startMonth").innerHTML = month[document.getElementById("monthSlide").valueLow-1];
        document.getElementById("endMonth").innerHTML = month[document.getElementById("monthSlide").valueHigh-1];
    }

    d3.select("#yearSlide").on("input", function() {  //updates the value per each slide. 
        update(this.value);
    });
    // update the fill of each SVG of class "incident" with value
    function update(value) {
        document.getElementById("startYear").innerHTML = year[document.getElementById("yearSlide").valueLow];
        document.getElementById("endYear").innerHTML = year[document.getElementById("yearSlide").valueHigh];


        // document.getElementById("range").innerHTML=year[document.getElementById("yearSlide").value]; //gets the slider value. 
        inputValue = year[value];
        // visualize(allData[value]);
    }

    var crimes = svg.append( "g" );    

    function visualize(passedData, animated){
        var filteredPassedData = [];
        for(var i = 0; i < passedData.length; i++){
            var calculatedMonth2 = new Date(passedData[i].properties["Date Reported"]).getMonth()+1;
            if(calculatedMonth2 >= document.getElementById("monthSlide").valueLow && calculatedMonth2 <= document.getElementById("monthSlide").valueHigh){
                filteredPassedData.push(passedData[i]);
            }
        }
        crimes.selectAll("circle").remove();
        
        if(animated){
            var step = 0;
            var dataToPlot = [];     
            dataToPlot.length = 0;   
            // console.log(dataToPlot);
            var pointAdd = setInterval(function(){
                // console.log(step);
                dataToPlot.push(filteredPassedData[step]);
                step += 1;
                // stop once all data is plotted
                if (step > filteredPassedData.length) {
                    clearInterval(pointAdd);
                } else {
                    addAPoint(dataToPlot);
                }	
            },1000 * Math.random());
        } else {
             addAPoint(filteredPassedData)
        }

    }
// fill: #ffd800;
 function addAPoint(dataToPlot){
        crimes.selectAll( "circle" )
            .data(dataToPlot)
            .enter()
            .append( "circle" )
            .attr("cx", function (d) { return albersProjection(d.geometry.coordinates)[0]; })
            .attr("cy", function (d) { return albersProjection(d.geometry.coordinates)[1]; })
            .attr("r", 5)
            .style("stroke-width", 5 / (i))
            // .attr( "fill", "red" )    //intial date checks which rows of data has year same as initially selected one. 
            // .attr( "stroke", "none" )  //same as above. 
            .attr( "d", geoPath )
            .attr( "class", "crime")
            .style("fill-opacity", .2) // set the fill opacity
            .style("stroke", "black")    // set the line colour
            .style("fill", "#ffd800")   // set the fill colour
            .on("mouseover", function(d){   //hover function - displays brief description regarding the incident. 
                var description = d.properties["Offense Type"];
                var result ="A ";
                var arr = description.split("-"); //splits the description into arrays. 
                for(var i = 0; i < arr.length; i++){    //parse throught the words and create human readable sentences. 
                    if(arr[i] == "FORCE"){
                        result += " forced burglary";
                    } else if (arr[i] == "NOFORCE"){
                        result += " non-forced burglary";
                    } else if(arr[i] == "SECURE PARKING"){
                        result += " burglary in a secure parking lot";
                    } else if (arr[i] == "NONRES"){
                        result += " at a non-residential area close to " +d.properties["Hundred Block Location"]+ " on " +d.properties["Date Reported"] +".";
                    }else if (arr[i] == "RES"){
                        result += " at a residential area close to " +d.properties["Hundred Block Location"]+ " on " +d.properties["Date Reported"] +".";
                    }     
                }
                d3.select("h2").text(result); //displays the constructed human-readble sntence in h2.
                d3.select(this).attr("class","crime hover"); 
                $(this).css("r", 10);
                $(this).css("fill", "brown");
                $(this).css("fill-opacity", 0.7);

            })
            .on("click", function(d){
                var x, y, k;
                if (d && centered !== d) {
                    var centroid = geoPath.centroid(d);
                    x = centroid[0];
                    y = centroid[1];
                    k = 4;
                    centered = d;
                } else {
                    x = width / 2;
                    y = height / 2;
                    k = 1;
                    centered = null;
                }
                g.selectAll("circle")
                    .classed("active", centered && function(d) { return d === centered; });
                g.transition()
                    .duration(750)
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                    .style("stroke-width", 1.5 / k + "px");
            })
            .on("mouseout", function(d){  //h2 reverts back to default text on hover-out. 
                d3.select("h2").text("Hover over plot points for incident description.");
                d3.select(this).attr("class","crime");
                $(this).css("r", 5);
            })
    }       
    

    

    

    //plays animation.
    var myTimer;
    d3.select("#start").on("click", function() {

        var calculatedYearData = [];
        for(var i = document.getElementById("yearSlide").valueLow; i <= document.getElementById("yearSlide").valueHigh; i++){
            allData[i].forEach(function(entry) {
                    calculatedYearData.push(entry)
            });
        } 
        visualize(calculatedYearData, false);
    });

    d3.select("#startWithAnimation").on("click", function() {

        var calculatedYearData = [];
        for(var i = document.getElementById("yearSlide").valueLow; i <= document.getElementById("yearSlide").valueHigh; i++){
            allData[i].forEach(function(entry) {
                    calculatedYearData.push(entry)
            });
        }
        visualize(calculatedYearData, true);
    });    

    d3.select("#stop").on("click", function() {
        location.reload(true);
    });






    </script>
    

    <!--script for second visualization-->
    <script>
    // var countsByMonth = [0,0,0,0,0,0,0,0,0,0,0,0]; //create an empty array with size 12 to count the occurences of crime per each month. 
    // for(var i = 0; i < crimedata.features.length; i++){
    //     countsByMonth[new Date(crimedata.features[i].properties["Date Reported"]).getMonth()]++;  //incremets the array. 
    // }
    var countX = 0;  //counter. 
    createVisualization2();

    var tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("font-family", "sans-serif")
        .style("font-size", "10px")
        .style("z-index", "10")
        .style("visibility", "hidden");    
    function createVisualization2(){

			var w = 360;
			var h = 360;
            var padding = 40;

            var xScale = d3.scale.linear()
                .domain([0, 12])
                .range([padding, w-padding]);

            var yScale = d3.scale.linear()
                .domain([0, d3.max(countsByMonth, function(d) {
                    return d;
                })])
                .range([h-padding, padding]);

			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h)
						.attr("style", "outline: none;");
                        
            var xAxis = d3.svg.axis()  //creates X Axis
                .scale(xScale)
                .orient("bottom")
                .ticks(11);
            var yAxis = d3.svg.axis()  //creates Y Axis
                .scale(yScale)
                .orient("left")
                .ticks(10);                
            
            

            svg.append("g")
                .attr("class", "axis")  //Assign "axis" class
			    .attr("transform", "translate(0," + (h - padding) + ")")
                .call(xAxis);
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + padding + ", 0)")
                .call(yAxis);                
            
            var value= ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            countX = 0;
            var myMap = new Map();  //create a map to get Month fvalue. 

			svg.selectAll("circle")
			   .data(countsByMonth)
			   .enter()
			   .append("circle")
			   .attr("cx", function(d) {
                   myMap.set(d, countX);
                   countX++;
			   	    return xScale(countX);
			   })
			   .attr("cy", function(d) {

			   		return yScale(d);
			   })
			   .attr("r", 8)
               .on("mouseover", function(d){
                    return tooltip.style("visibility", "visible").text(value[myMap.get(d)] +": "+d);    //displays the month and count of crimes on hover. 
                })
                .on("mousemove", function(d){
                    return tooltip.style("top", (event.pageY-20)+"px").style("left",(event.pageX+10)+"px").text(value[myMap.get(d)] +": "+d); //displays the month and conut of crimes on hover. 
                })
                .on("mouseout", function(d){
                    return tooltip.style("visibility", "hidden");
                });
    }

                               
    </script>
